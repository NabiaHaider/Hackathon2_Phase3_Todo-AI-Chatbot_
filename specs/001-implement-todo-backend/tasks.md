# Implementation Tasks: Todo App Backend

**Feature Branch**: `001-implement-todo-backend`
**Date**: 2026-02-03
**Plan**: [plan.md](plan.md)
**Spec**: [spec.md](spec.md)

## Dependencies

- User Story 1 (Manage Tasks) is a prerequisite for User Story 2 (Filter and Toggle Tasks).

## Parallel Execution Opportunities

- Within the Setup Phase, `T002` and `T003` can be done in parallel if the `auth` and `routes` directories are created first.
- Within the Foundational Phase, `T005` (defining the Task model) and `T006` (defining Pydantic schemas) can be largely parallel once `T004` (db connection) is established.
- Within User Story Phases, tasks related to different endpoints can often be implemented in parallel if they operate on the same models/services, but for simplicity and clear dependency, they are listed sequentially here. However, `GET`, `POST` can be developed somewhat independently from `PUT`, `DELETE`.

## Implementation Strategy

The implementation will follow a phased approach, prioritizing core CRUD functionality (User Story 1) before enhancing with filtering and toggling (User Story 2). Each phase will build upon the previous one, ensuring a stable foundation. We will focus on implementing the backend logic and API endpoints first, ensuring strict adherence to JWT authentication, user isolation, and error handling as defined in the `plan.md`. Integration with the existing frontend will be validated at the end of each major user story implementation.

## Phase 1: Setup

Goal: Establish the basic project structure and install necessary dependencies.

### Implementation Tasks

- [X] T001 Create backend directory structure `/backend/auth`, `/backend/routes`
- [X] T002 [P] Install core dependencies: `fastapi`, `uvicorn`, `sqlmodel`, `python-jose`, `passlib` in `/backend`
- [X] T003 [P] Configure `.gitignore` for `/backend` to exclude `venv`, `__pycache__`
- [X] T020 [P] Create and populate `/backend/requirements.txt` with all project dependencies to ensure a reproducible setup.
- [X] T021 [P] Install `python-dotenv` and add it to `/backend/requirements.txt`.

## Phase 2: Foundational Components

Goal: Implement database connection, SQLModel setup, base authentication, and main FastAPI app.

### Implementation Tasks

- [X] T004 Implement database engine and session management in `backend/db.py`
  - Initialize `create_engine` using `Neon_db_url` from environment
  - Implement `create_db_and_tables()` with `checkfirst=True`
  - Implement `get_session()` dependency
- [X] T005 Define SQLModel `Task` model in `backend/models.py`
  - Inherit from `SQLModel`, `@table` decorator
  - Define `id`, `user_id`, `title`, `description`, `completed`, `created_at`, `updated_at` fields
  - Ensure timestamps are UTC, generated by backend, and `updated_at` updates on modification
- [X] T006 Define Pydantic schemas (`TaskBase`, `TaskCreate`, `TaskUpdate`, `TaskRead`) in `backend/schemas.py`
  - Ensure `TaskRead` explicitly excludes `user_id`
- [X] T007 Implement JWT verification logic in `backend/auth/jwt.py`
  - Read `BETTER_AUTH_SECRET`
  - Create `OAuth2PasswordBearer` scheme
  - Implement `get_current_user()` dependency:
    - Decode JWT, extract `user_id` claim
    - Raise 401 for invalid/expired token or missing `user_id` claim
    - Ensure `user_id` is always from JWT, never client input
- [X] T008 Setup main FastAPI application in `backend/main.py`
  - Instantiate `FastAPI`
  - Configure CORS for `http://localhost:3000` with `CORSMiddleware`
  - Add startup event to call `create_db_and_tables()`
  - Configure `python-dotenv` to securely load `.env` variables.
- [X] T022 [P] Implement `GET /api/health` endpoint in `backend/main.py` for health and database connectivity checks.

## Phase 3: User Story 1 - Manage Tasks [US1]

Goal: Enable authenticated users to create, retrieve, update, and delete their own tasks.

### Independent Test Criteria

An authenticated user can:
- Log in (frontend handles this)
- Create a new task via `POST /api/tasks`
- See only their own tasks via `GET /api/tasks`
- Retrieve a specific task via `GET /api/tasks/{id}`
- Update a task via `PUT /api/tasks/{id}`
- Delete a task via `DELETE /api/tasks/{id}`
- Attempting to access/modify another user's task results in 404

### Implementation Tasks

- [X] T009 [US1] Create API router in `backend/routes/tasks.py`
- [X] T010 [US1] Implement `POST /api/tasks` endpoint in `backend/routes/tasks.py`
  - Use `TaskCreate` schema
  - Inject `user_id` from `get_current_user()`
  - Set `user_id` on new task
  - Return `TaskRead`
- [X] T011 [US1] Implement `GET /api/tasks` endpoint in `backend/routes/tasks.py`
  - Inject `user_id` from `get_current_user()`
  - Filter tasks by `user_id`
  - Return list of `TaskRead`
- [X] T012 [US1] Implement `GET /api/tasks/{id}` endpoint in `backend/routes/tasks.py`
  - Inject `user_id` from `get_current_user()`
  - Query task by `id` AND `user_id`
  - Return 404 if not found/not owned
  - Return `TaskRead`
- [X] T013 [US1] Implement `PUT /api/tasks/{id}` endpoint in `backend/routes/tasks.py`
  - Inject `user_id` from `get_current_user()`
  - Use `TaskUpdate` schema
  - Query task by `id` AND `user_id`
  - Return 404 if not found/not owned
  - Update `title`, `description`, `updated_at`
  - Return `TaskRead`
- [X] T014 [US1] Implement `DELETE /api/tasks/{id}` endpoint in `backend/routes/tasks.py`
  - Inject `user_id` from `get_current_user()`
  - Query task by `id` AND `user_id`
  - Return 404 if not found/not owned
  - Delete task
  - Return success message with 200 status

## Phase 4: User Story 2 - Filter and Toggle Tasks [US2]

Goal: Enable authenticated users to filter their tasks and toggle their completion status.

### Independent Test Criteria

An authenticated user can:
- Mark a task complete/pending via `PATCH /api/tasks/{id}/complete`
- Filter their tasks by `status=pending`, `status=completed`, `status=all` via `GET /api/tasks`

### Implementation Tasks

- [X] T015 [US2] Enhance `GET /api/tasks` endpoint in `backend/routes/tasks.py` to support `status` filter
  - Accept optional `status` query param (`all`, `pending`, `completed`)
  - Add `where(Task.completed == True/False)` clause based on status
- [X] T016 [US2] Implement `PATCH /api/tasks/{id}/complete` endpoint in `backend/routes/tasks.py`
  - Inject `user_id` from `get_current_user()`
  - Query task by `id` AND `user_id`
  - Return 404 if not found/not owned
  - Toggle `completed` status
  - Update `updated_at`
  - Return `TaskRead`

## Phase 5: Polish & Cross-Cutting Concerns

Goal: Ensure robust error handling, logging safety, and final integration.

### Implementation Tasks

- [X] T017 Implement consistent error response format in `backend/main.py` (or through FastAPI's default `HTTPException` handling)
  - Ensure all error responses are `{ "detail": "error message" }`
- [X] T018 Verify logging practices in `backend/main.py`, `backend/auth/jwt.py`, `backend/routes/tasks.py`
  - Ensure no sensitive data (JWTs, secrets, DB credentials) is logged
  - Implement generic 500 error for unexpected exceptions
- [X] T019 Conduct final integration testing with frontend
  - Verify all CRUD, filtering, toggling operations work from frontend
  - Confirm error responses are correctly handled by frontend
  - Ensure no frontend changes are required
- [X] T023 [P] Enhance JWT verification in `backend/auth/jwt.py` to validate the `Authorization: Bearer <token>` format and reject requests that do not match.
- [X] T024 [P] Verify that the API router prefix in `backend/main.py` is consistently set to `/api/tasks` to match frontend expectations.

## Phase 6: Authentication Backend

Goal:
Implement backend authentication to support existing frontend signup and login pages.

Tasks:

- [X] T025 Create backend/models/user.py
  Fields:
  id
  email
  hashed_password
  created_at

- [X] T026 Create backend/schemas/user.py
  UserCreate
  UserLogin
  UserResponse
  TokenResponse

- [X] T027 Create backend/routes/auth.py

- [X] T028 Implement POST /api/auth/signup
  - hash password using passlib bcrypt
  - save user
  - return success response

- [X] T029 Implement POST /api/auth/login
  - verify email/password
  - generate JWT token using BETTER_AUTH_SECRET
  - payload must include:
    { "user_id": user.id }

- [X] T030 Register auth router in main.py
  app.include_router(auth.router, prefix="/api/auth")

- [X] T031 Ensure tasks endpoints use existing get_current_user JWT dependency